<script src="coi-serviceworker.js"></script>
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­‹ãƒˆãƒ¬Webã‚¢ãƒ—ãƒª - æœ€çµ‚å®Œæˆç‰ˆ</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: #f4f4f9; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .app-container { width: 375px; height: 667px; background: white; border-radius: 12px; position: relative; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .screen { display: none; width: 100%; height: 100%; padding: 20px; box-sizing: border-box; overflow-y: auto; position: absolute; }
        .active { display: block; }
        .header { display: flex; justify-content: space-between; align-items: center; background: #e0f7fa; padding: 10px; border-radius: 8px; margin-bottom: 15px; }
        .header h2 { margin: 0; color: #00796b; font-size: 1.1em; }
        .wasm-area { background: #fffaf0; border: 1px solid #ffe0b2; padding: 15px; border-radius: 8px; margin-top: 10px; }
        .range-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 8px; font-size: 0.8em; align-items: center; }
        input[type="number"], select, input[type="text"] { padding: 6px; border-radius: 4px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; }
        button { cursor: pointer; border: none; border-radius: 6px; padding: 10px; font-weight: bold; transition: 0.2s; }
        .primary-btn { background: #e91e63; color: white; width: 100%; }
        .secondary-btn { background: #00bcd4; color: white; flex: 1; }
        #dashboard { display: flex; justify-content: space-around; background: #fafafa; padding: 10px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 15px; text-align: center; }
        .dash-item span { display: block; font-size: 0.7em; color: #777; }
        .dash-item b { font-size: 0.9em; color: #333; }
        
        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
        #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .cal-weekday { font-size: 0.7em; font-weight: bold; color: #777; padding: 5px 0; text-align: center; }
        .cal-day { padding: 8px 0; background: #f5f5f5; border-radius: 4px; font-size: 0.8em; cursor: pointer; text-align: center; border: 2px solid transparent; min-height: 40px; }
        .cal-empty { background: transparent; }

        /* å‰Šé™¤ãƒœã‚¿ãƒ³ä»˜ãã®è¨˜éŒ²ãƒªã‚¹ãƒˆ */
        .record-item { display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; padding: 5px 8px; margin-bottom: 4px; border-radius: 4px; font-size: 0.9em; }
        .delete-btn { background: #ff5252; color: white; padding: 2px 6px; font-size: 0.7em; border-radius: 3px; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #record-modal { display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center; }
        .modal-content { background:white; width:90%; padding:20px; border-radius:10px; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="screen1" class="screen active">
        <div class="header"><h2>ç­‹ãƒˆãƒ¬ã‚¢ãƒ—ãƒª</h2><button onclick="showScreen('screen7')">MY</button></div>
        <div id="dashboard">
            <div class="dash-item"><span>åŸºç¤ä»£è¬</span><b id="dash-bmr">---</b></div>
            <div class="dash-item"><span>åˆè¨ˆæ¶ˆè²»</span><b id="dash-total-burned" style="color:#e91e63;">0 kcal</b></div>
        </div>
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button class="secondary-btn" onclick="openCalendar()">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</button>
            <button class="secondary-btn" onclick="showScreen('screen5')" style="background:#4caf50;">ã‚¿ã‚¤ãƒãƒ¼</button>
        </div>
        <div class="wasm-area">
            <h4>çŒ®ç«‹æ¤œç´¢ Wasm å®Ÿé¨“ (100ä¸‡ä»¶)</h4>
            <select id="thread-select" style="margin-bottom:10px;">
                <option value="1">1 Thread</option><option value="2">2 Threads</option>
                <option value="3">3 Threads</option><option value="4" selected>4 Threads</option>
            </select>
            <div class="range-grid">
                <span>ã‚«ãƒ­ãƒªãƒ¼</span><div><input type="number" id="min-cal" value="300" style="width:45%">~<input type="number" id="max-cal" value="600" style="width:45%"></div>
                <span>ã‚¿ãƒ³ãƒ‘ã‚¯è³ª</span><div><input type="number" id="min-p" value="20" style="width:45%">~<input type="number" id="max-p" value="50" style="width:45%"></div>
                <span>ç‚­æ°´åŒ–ç‰©</span><div><input type="number" id="min-c" value="0" style="width:45%">~<input type="number" id="max-c" value="100" style="width:45%"></div>
                <span>è„‚è³ª</span><div><input type="number" id="min-f" value="0" style="width:45%">~<input type="number" id="max-f" value="40" style="width:45%"></div>
            </div>
            <button class="primary-btn" style="margin-top:10px;" onclick="startDietSearch()">æ¤œç´¢å®Ÿè¡Œ</button>
        </div>
    </div>

    <div id="screen2" class="screen">
        <div class="header"><button onclick="showScreen('screen1')">â†</button><h2>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2></div>
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; align-items:center;">
            <button onclick="changeMonth(-1)">ï¼œ</button><b id="cal-label"></b><button onclick="changeMonth(1)">ï¼</button>
        </div>
        <div id="calendar-grid"></div>
    </div>

    <div id="screen5" class="screen">
        <div class="header"><button onclick="showScreen('screen1')">â†</button><h2>ã‚¿ã‚¤ãƒãƒ¼è¨­å®š</h2></div>
        <div class="wasm-area">
            <div class="range-grid">
                <span>é‹å‹•æ™‚é–“(ç§’)</span><input type="number" id="w-sec" value="30">
                <span>ãƒ¬ã‚¹ãƒˆæ™‚é–“(ç§’)</span><input type="number" id="r-sec" value="10">
                <span>ã‚»ãƒƒãƒˆæ•°</span><input type="number" id="s-count" value="4">
            </div>
            <button class="primary-btn" style="margin-top:15px; background:#4caf50;" onclick="startTimer()">ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        </div>
    </div>
    
    <div id="screen6" class="screen" style="background:#222; color:white; text-align:center;">
        <h2 id="t-status" style="margin-top:50px; color:#ffeb3b;">WORKOUT</h2>
        <div id="t-clock" style="font-size:5em; margin:30px 0;">00</div>
        <p id="t-sets">Set: 1 / --</p>
        <button onclick="stopTimer()" style="background:#f44336; color:white;">QUIT</button>
    </div>

    <div id="screen7" class="screen">
        <div class="header"><button onclick="showScreen('screen1')">â†</button><h2>ãƒã‚¤ãƒšãƒ¼ã‚¸</h2></div>
        <div class="wasm-area">
            <div class="range-grid">
                <span>æ€§åˆ¥</span><select id="p-gen"><option value="male">ç”·æ€§</option><option value="female">å¥³æ€§</option></select>
                <span>èº«é•· (cm)</span><input type="number" id="p-h" value="170">
                <span>ä½“é‡ (kg)</span><input type="number" id="p-w" value="65">
                <span>å¹´é½¢ (æ­³)</span><input type="number" id="p-a" value="25">
                <span>èº«ä½“æ´»å‹•ãƒ¬ãƒ™ãƒ«</span>
                <select id="p-pal">
                    <option value="1.2">ä½ï¼ˆé‹å‹•ãªã—ï¼‰</option>
                    <option value="1.55" selected>ä¸­ï¼ˆé€±1-3å›é‹å‹•ï¼‰</option>
                    <option value="1.8">é«˜ï¼ˆé€±3-5å›é‹å‹•ï¼‰</option>
                </select>
            </div>
            <button class="primary-btn" style="margin-top:15px; background:#4caf50;" onclick="saveProfile()">è¨­å®šã‚’ä¿å­˜</button>
        </div>
    </div>

    <div id="screen_res" class="screen">
        <div class="header"><h2>æ¤œç´¢çµæœ</h2></div>
        <div id="res-list"></div>
        <button class="primary-btn" onclick="showScreen('screen1')" style="background:#666;">æˆ»ã‚‹</button>
    </div>

    <div id="record-modal">
        <div class="modal-content">
            <h3 id="modal-date-title" style="margin-top:0;"></h3>
            <div id="record-list" style="margin-bottom:12px; font-size:0.85em; max-height:120px; overflow-y:auto; border-bottom:1px solid #eee; padding-bottom:5px;"></div>
            <div class="range-grid">
                <span>éƒ¨ä½</span><select id="category-select" onchange="updateMenuOptions()"><option value="èƒ¸">èƒ¸</option><option value="èƒŒä¸­">èƒŒä¸­</option><option value="è„š">è„š</option><option value="è‚©">è‚©</option><option value="è…•">è…•</option><option value="ä½“å¹¹">ä½“å¹¹</option></select>
                <span>ãƒ¡ãƒ‹ãƒ¥ãƒ¼</span><select id="menu-select"></select>
                <span>å›æ•°</span><input type="number" id="input-reps" value="10">
            </div>
            <button class="primary-btn" style="background:#4caf50; margin-top:15px;" onclick="addTrainingRecord()">è¿½åŠ </button>
            <button class="primary-btn" style="background:#666; margin-top:5px;" onclick="closeModal()">é–‰ã˜ã‚‹</button>
        </div>
    </div>
</div>

<script>
    let calendarDate = new Date();
    let selectedDateStr = "";
    let timerInterval = null;
    let WasmModuleInstance = null;

    const TRAINING_CATALOG = {
        "èƒ¸": [{name:"ãƒ—ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—", kcal:0.5},{name:"ãƒ€ãƒ³ãƒ™ãƒ«ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹", kcal:0.6},{name:"ã‚¤ãƒ³ã‚¯ãƒ©ã‚¤ãƒ³ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹", kcal:0.65},{name:"ãƒ‡ã‚¯ãƒ©ã‚¤ãƒ³ãƒ—ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—", kcal:0.55}],
        "èƒŒä¸­": [{name:"æ‡¸å‚", kcal:1.2},{name:"ãƒ€ãƒ³ãƒ™ãƒ«ãƒ­ãƒ¼ã‚¤ãƒ³ã‚°", kcal:0.6},{name:"ãƒ‡ãƒƒãƒˆãƒªãƒ•ãƒˆ", kcal:1.5},{name:"ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒãƒ³", kcal:0.3}],
        "è„š": [{name:"ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ", kcal:0.8},{name:"ãƒ©ãƒ³ã‚¸", kcal:0.7},{name:"ãƒãƒ¼ãƒ™ãƒ«ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ", kcal:1.4},{name:"ã‚«ãƒ¼ãƒ•ãƒ¬ã‚¤ã‚º", kcal:0.2}],
        "è‚©": [{name:"ã‚·ãƒ§ãƒ«ãƒ€ãƒ¼ãƒ—ãƒ¬ã‚¹", kcal:0.5},{name:"ã‚µã‚¤ãƒ‰ãƒ¬ã‚¤ã‚º", kcal:0.4},{name:"ã‚¢ãƒ¼ãƒãƒ«ãƒ‰ãƒ—ãƒ¬ã‚¹", kcal:0.55},{name:"ãƒ•ãƒ­ãƒ³ãƒˆãƒ¬ã‚¤ã‚º", kcal:0.4}],
        "è…•": [{name:"ãƒ€ãƒ³ãƒ™ãƒ«ã‚«ãƒ¼ãƒ«", kcal:0.3},{name:"ãƒŠãƒ­ãƒ¼ãƒ—ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—", kcal:0.5},{name:"ãƒªã‚¹ãƒˆã‚«ãƒ¼ãƒ«", kcal:0.1}],
        "ä½“å¹¹": [{name:"ãƒ—ãƒ©ãƒ³ã‚¯(ç§’)", kcal:0.1},{name:"ãƒ¬ãƒƒã‚°ãƒ¬ã‚¤ã‚º", kcal:0.4},{name:"ã‚¢ãƒ–ãƒ­ãƒ¼ãƒ©ãƒ¼", kcal:0.7},{name:"ãƒã‚¤ã‚·ã‚¯ãƒ«ã‚¯ãƒ©ãƒ³ãƒ", kcal:0.5}]
    };

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function updateDashboard() {
        const prof = JSON.parse(localStorage.getItem('user_profile') || '{"bmr":0}');
        const details = JSON.parse(localStorage.getItem('training_details') || '{}');
        const calData = JSON.parse(localStorage.getItem('cal_data') || '{}');
        const today = new Date().toISOString().split('T')[0];
        let exBurned = 0;
        if(details[today]) { details[today].forEach(r => { for(let cat in TRAINING_CATALOG) { const item = TRAINING_CATALOG[cat].find(i => i.name === r.menu); if(item) { exBurned += r.reps * item.kcal; break; } } }); }
        exBurned += (calData[today] || 0);
        document.getElementById('dash-bmr').textContent = Math.round(prof.bmr) + " kcal";
        document.getElementById('dash-total-burned').textContent = Math.round(prof.bmr + exBurned) + " kcal";
    }

    function openCalendar() { showScreen('screen2'); renderCalendar(); }
    function changeMonth(n) { calendarDate.setMonth(calendarDate.getMonth() + n); renderCalendar(); }
    function renderCalendar() {
        const y = calendarDate.getFullYear(), m = calendarDate.getMonth();
        const now = new Date();
        document.getElementById('cal-label').textContent = `${y}å¹´ ${m+1}æœˆ`;
        const grid = document.getElementById('calendar-grid'); grid.innerHTML = '';
        ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].forEach(wd => grid.innerHTML += `<div class="cal-weekday">${wd}</div>`);
        const firstDay = new Date(y, m, 1).getDay();
        const lastDate = new Date(y, m + 1, 0).getDate();
        const details = JSON.parse(localStorage.getItem('training_details') || '{}');
        for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div class="cal-day cal-empty"></div>`;
        for(let d=1; d<=lastDate; d++){
            const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const cell = document.createElement('div'); cell.className = 'cal-day';
            if(now.getFullYear()===y && now.getMonth()===m && now.getDate()===d) { cell.style.backgroundColor = "#E0F2F1"; cell.style.borderColor = "#009688"; }
            cell.innerHTML = `<b>${d}</b>` + (details[dateStr]?.length > 0 ? '<br>âœ…' : '');
            cell.onclick = () => { selectedDateStr = dateStr; openModal(); };
            grid.appendChild(cell);
        }
    }

    function openModal() { document.getElementById('modal-date-title').textContent = selectedDateStr; document.getElementById('record-modal').style.display='flex'; updateMenuOptions(); displayRecords(); }
    function closeModal() { document.getElementById('record-modal').style.display='none'; }
    function updateMenuOptions() { const cat = document.getElementById('category-select').value; document.getElementById('menu-select').innerHTML = TRAINING_CATALOG[cat].map(m => `<option value="${m.name}">${m.name}</option>`).join(''); }

    // ğŸ’¡ å‰Šé™¤æ©Ÿèƒ½ä»˜ãã®è¨˜éŒ²è¡¨ç¤º
    function displayRecords() {
        const details = JSON.parse(localStorage.getItem('training_details') || '{}');
        const records = details[selectedDateStr] || [];
        const container = document.getElementById('record-list');
        if (records.length === 0) {
            container.innerHTML = "è¨˜éŒ²ãªã—";
        } else {
            container.innerHTML = records.map((r, index) => `
                <div class="record-item">
                    <span>${r.menu} (${r.reps}å›)</span>
                    <button class="delete-btn" onclick="deleteTrainingRecord(${index})">å‰Šé™¤</button>
                </div>
            `).join('');
        }
    }

    // ğŸ’¡ ç‰¹å®šã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®è¨˜éŒ²ã‚’å‰Šé™¤
    function deleteTrainingRecord(index) {
        let details = JSON.parse(localStorage.getItem('training_details') || '{}');
        if (details[selectedDateStr]) {
            details[selectedDateStr].splice(index, 1);
            localStorage.setItem('training_details', JSON.stringify(details));
            displayRecords();
            renderCalendar();
            updateDashboard();
        }
    }

    function addTrainingRecord() { const menu = document.getElementById('menu-select').value; const reps = parseInt(document.getElementById('input-reps').value); if(!reps) return; let d = JSON.parse(localStorage.getItem('training_details') || '{}'); if(!d[selectedDateStr]) d[selectedDateStr] = []; d[selectedDateStr].push({menu, reps}); localStorage.setItem('training_details', JSON.stringify(d)); displayRecords(); renderCalendar(); updateDashboard(); }

    async function startDietSearch() {
        const t = document.getElementById('thread-select').value;
        window.foundResults = [];
        showScreen('screen_res'); document.getElementById('res-list').innerHTML = "è¨ˆç®—ä¸­...";
        const s = document.createElement('script'); s.src = `diet_search_${t}t.js`; document.body.appendChild(s);
        s.onload = () => Module().then(inst => {
            WasmModuleInstance = inst;
            const search = inst.cwrap('perform_multi_thread_search','number',['number','number','number','number','number','number','number','number','number']);
            const time = search(t, document.getElementById('min-cal').value, document.getElementById('max-cal').value, document.getElementById('min-p').value, document.getElementById('max-p').value, document.getElementById('min-c').value, document.getElementById('max-c').value, document.getElementById('min-f').value, document.getElementById('max-f').value);
            inst._report_results_to_js();
            let html = `<b>Time: ${time.toFixed(3)} ms</b><br>Hits: ${inst._get_found_menu_count_value()}<hr>`;
            window.foundResults.forEach(m => html += `<div>${m.name} (${m.cal}kcal)</div>`);
            document.getElementById('res-list').innerHTML = html;
        });
    }

    function startTimer() {
        const w = parseInt(document.getElementById('w-sec').value), r = parseInt(document.getElementById('r-sec').value), total = parseInt(document.getElementById('s-count').value);
        let cur = 1, resting = false, left = w;
        showScreen('screen6');
        timerInterval = setInterval(() => { document.getElementById('t-clock').textContent = left; document.getElementById('t-sets').textContent = `Set: ${cur} / ${total}`; if(left-- <= 0) { if(!resting) { resting = true; left = r; document.getElementById('t-status').textContent="REST"; } else { resting = false; cur++; if(cur > total) finishTimer(total * w); else { left = w; document.getElementById('t-status').textContent="WORKOUT"; } } } }, 1000);
    }
    function finishTimer(sec) { const burned = Math.round(sec * 0.15); const today = new Date().toISOString().split('T')[0]; let data = JSON.parse(localStorage.getItem('cal_data') || '{}'); data[today] = (data[today] || 0) + burned; localStorage.setItem('cal_data', JSON.stringify(data)); stopTimer(); }
    function stopTimer() { clearInterval(timerInterval); updateDashboard(); showScreen('screen1'); }

    function saveProfile() {
        const h = document.getElementById('p-h').value, w = document.getElementById('p-w').value, a = document.getElementById('p-a').value, pal = document.getElementById('p-pal').value;
        const bmr = (document.getElementById('p-gen').value === 'male') ? (13.4*w + 4.8*h - 5.7*a + 88) : (9.2*w + 3.1*h - 4.3*a + 447);
        localStorage.setItem('user_profile', JSON.stringify({bmr})); updateDashboard(); alert("ä¿å­˜å®Œäº†");
    }

    window.onload = updateDashboard;
</script>
</body>

</html>
